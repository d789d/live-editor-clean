const mongoose = require('mongoose');
const Prompt = require('../backend/models/Prompt');
const config = require('../backend/config/env');

// ×¤×¨×•××¤×˜×™× ××”×§×•×“ ×”××§×•×¨×™
const INITIAL_PROMPTS = [
    {
        name: '×¤×™×¡×•×§ ××œ×',
        key: 'punctuation',
        type: 'punctuation',
        category: 'torah',
        description: '×¤×™×¡×•×§ ××œ× ×¢× ×›×œ×œ×™× ××¤×•×¨×˜×™× ×œ×˜×§×¡×˜×™× ×ª×•×¨× ×™×™×',
        content: `×¤×™×¡×•×§ 3 - ×¤×™×¡×•×§ ××œ×

×¢× ×¡×™×× ×™ ×©××œ×” ×•×§×¨×™××”. ×”×’×“×¨×”: ×›×•×œ×œ ×¤×¡×™×§×™×, × ×§×•×“×•×ª, × ×§×•×“×•×ª×™×™×, ××¨×›××•×ª.

**×”×¢×¨×ª ×¢×¦×××•×ª**: ×‘×‘×™×¦×•×¢ ×©×œ×‘ ×–×”, ×™×˜×•×¤×œ×• ××š ×•×¨×§ ×¢× ×™×™× ×™ ×¤×™×¡×•×§. ××™×Ÿ ×œ×©× ×•×ª ××™×œ×™× ×‘×’×•×£ ×”×˜×§×¡×˜, ×©×•× ××™×œ×” ×•×©×•× ××•×ª. ××™×Ÿ ×œ×’×¢×ª ×‘××‘× ×” ×”×§×˜×¢×™×, ×‘××¨××™ ×”××§×•××•×ª ××• ×‘×›×•×ª×¨×•×ª ×”×§×™×™××•×ª.

1. ×¡×™×× ×™ ×¤×™×¡×•×§ - ×›×œ×œ×™× ×•×¢×§×¨×•× ×•×ª:
- ×¤×™×¡×•×§ ×›×•×œ×œ: ×¤×¡×™×§×™×, × ×§×•×“×•×ª, ×•× ×§×•×“×•×ª×™×™×
- ×©×™××•×© ××™× ×™××œ×™ ×‘×¡×™×× ×™ ×¤×™×¡×•×§
- ×©××™×¨×” ×¢×œ ×¡×’× ×•×Ÿ ×”×›×ª×™×‘×” ×”××¡×•×¨×ª×™

2. ×©×™××•×© ×‘× ×§×•×“×”:
- ×‘×¡×•×£ ××©×¤×˜
- ×œ××—×¨ ×¨××©×™ ×ª×™×‘×•×ª
- ×‘×¡×™×•× ×¨×¢×™×•×Ÿ
- ×œ×¤× ×™ ×”×ª×—×œ×ª × ×•×©× ×—×“×©

3. ×©×™××•×© ×‘×¤×¡×™×§:
- ×‘×™×Ÿ ×—×œ×§×™ ××©×¤×˜
- ×‘×¨×©×™××•×ª
- ×œ×¤× ×™ ××™×œ×•×ª ×§×™×©×•×¨
- ×œ×”×¤×¨×“×” ×‘×™×Ÿ ×¨×¢×™×•× ×•×ª ××©× ×™×™×

4. ×©×™××•×© ×‘× ×§×•×“×ª×™×™×:
×‘×¦×™×˜×•×˜ ×©×œ ×¤×¡×•×§×™×
×“×•×’××: ×›××• ×©× ×××¨: '×‘×¨××©×™×ª ×‘×¨× ××œ×§×™×'.

5. ×¡×™×× ×™ ××¨×›××•×ª:
×‘×¦×™×˜×•×˜ ×¤×¡×•×§×™× ×•××“×¨×©×™×, ×”×©×ª××© ×‘××¨×›××” ××—×ª.
×œ×“×•×’××: '×‘×¨×›×•×ª ××‘×™×š ×’×‘×¨×•'.

6. ×¡×™×× ×™ ×©××œ×” ×•×§×¨×™××”:
- ×”×™×× ×¢×•×ª ×›××¢×˜ ××•×—×œ×˜×ª ××©×™××•×© ×‘×¡×™××Ÿ ×§×¨×™××”
- ×¡×™××Ÿ ×©××œ×” ×¨×§ ×‘×§×•×©×™×•×ª ××¤×•×¨×©×•×ª`,
        tags: ['×¤×™×¡×•×§', '×ª×•×¨×”', '×¢×‘×¨×™×ª']
    },
    {
        name: '× ×™×§×•×“ ×˜×§×¡×˜',
        key: 'nikud',
        type: 'nikud',
        category: 'torah',
        description: '×”×•×¡×¤×ª × ×™×§×•×“ ××œ× ×•××“×•×™×§ ×œ×˜×§×¡×˜ ×¢×‘×¨×™',
        content: '×”×•×¡×£ × ×™×§×•×“ ××œ× ×•××“×•×™×§ ×œ×˜×§×¡×˜ ×”×¢×‘×¨×™ ×”×‘×. ×”×§×¤×“ ×¢×œ ×“×™×•×§ ×‘×”×‘×¨×•×ª ×•×‘×”×˜×¢××•×ª:',
        tags: ['× ×™×§×•×“', '×¢×‘×¨×™×ª', '×”×’×™×™×”']
    },
    {
        name: '×§×™×¦×•×¨ ×˜×§×¡×˜',
        key: 'truncate',
        type: 'truncate',
        category: 'general',
        description: '×§×™×¦×•×¨ ×˜×§×¡×˜ ×ª×•×š ×©××™×¨×” ×¢×œ ×”×¨×¢×™×•× ×•×ª ×”××¨×›×–×™×™×',
        content: '×§×¦×¨ ××ª ×”×˜×§×¡×˜ ×”×‘× ×ª×•×š ×©××™×¨×” ×¢×œ ×”×¨×¢×™×•× ×•×ª ×”××¨×›×–×™×™×. ×”×§×¤×“ ×¢×œ ×‘×”×™×¨×•×ª ×•×§×™×¦×•×¨:',
        tags: ['×§×™×¦×•×¨', '×ª×§×¦×™×¨', '×¢×¨×™×›×”']
    },
    {
        name: '××§×•×¨×•×ª ×•××¨××™ ××§×•××•×ª',
        key: 'sources',
        type: 'sources',
        category: 'torah',
        description: '×”×•×¡×¤×ª ××¨××™ ××§×•××•×ª ×•××§×•×¨×•×ª ×¨×œ×•×•× ×˜×™×™×',
        content: '×”×•×¡×£ ××¨××™ ××§×•××•×ª ×•××§×•×¨×•×ª ×¨×œ×•×•× ×˜×™×™× ×œ×˜×§×¡×˜ ×”×‘×. ×›×œ×•×œ ×¤×¡×•×§×™×, ×’××¨×, ××“×¨×©×™× ×•××§×•×¨×•×ª ×¨×œ×•×•× ×˜×™×™×:',
        tags: ['××§×•×¨×•×ª', '××¨××™ ××§×•××•×ª', '×ª×•×¨×”', '×”×œ×›×”']
    },
    {
        name: '×¢×¨×™×›×ª ×˜×§×¡×˜',
        key: 'edit',
        type: 'edit',
        category: 'general',
        description: '×¢×¨×™×›×” ×œ×©×™×¤×•×¨ ×‘×”×™×¨×•×ª, ×“×™×•×§ ×•×–×¨×™××”',
        content: '×¢×¨×•×š ××ª ×”×˜×§×¡×˜ ×”×‘× ×œ×©×™×¤×•×¨ ×”×‘×”×™×¨×•×ª, ×”×“×™×•×§ ×•×”×–×¨×™××”. ×ª×§×Ÿ ×©×’×™××•×ª ×•×©×¤×¨ ××ª ×”× ×™×¡×•×—:',
        tags: ['×¢×¨×™×›×”', '×©×™×¤×•×¨', '×‘×”×™×¨×•×ª']
    },
    {
        name: '×¢×™×¦×•×‘ ×•×—×™×–×•×§',
        key: 'format',
        type: 'format',
        category: 'general',
        description: '×¢×™×¦×•×‘ ×˜×§×¡×˜ ×¢× ×”×“×’×©×•×ª ×•××‘× ×” ×‘×¨×•×¨',
        content: '×¢×¦×‘ ××ª ×”×˜×§×¡×˜ ×”×‘× ×¢× ×”×“×’×©×•×ª ××ª××™××•×ª (**), ××‘× ×” ×‘×¨×•×¨ ×•×¢×™×¦×•×‘ ××§×¦×•×¢×™:',
        tags: ['×¢×™×¦×•×‘', '×¤×•×¨××˜', '×”×“×’×©×•×ª']
    },
    {
        name: '×‘×“×™×§×ª ×“×§×“×•×§',
        key: 'grammar',
        type: 'grammar',
        category: 'general',
        description: '×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ×©×’×™××•×ª ×“×§×“×•×§ ×•×›×ª×™×‘',
        content: '×‘×“×•×§ ×•×ª×§×Ÿ ×©×’×™××•×ª ×“×§×“×•×§, ×›×ª×™×‘ ×•× ×™×¡×•×— ×‘×˜×§×¡×˜ ×”×‘×:',
        tags: ['×“×§×“×•×§', '×›×ª×™×‘', '×ª×™×§×•×Ÿ']
    },
    {
        name: '× ×™×ª×•×— ×˜×§×¡×˜',
        key: 'analyze',
        type: 'analyze',
        category: 'general',
        description: '× ×™×ª×•×— ××¢××™×§ ×©×œ ×ª×•×›×Ÿ, ××‘× ×” ×•× ×•×©××™×',
        content: '× ×ª×— ××ª ×”×˜×§×¡×˜ ×”×‘× - ×ª×•×›×Ÿ, ××‘× ×”, × ×•×©××™× ××¨×›×–×™×™× ×•××¡×§× ×•×ª:',
        tags: ['× ×™×ª×•×—', '×ª×•×›×Ÿ', '××—×§×¨']
    },
    {
        name: '×ª×¨×’×•×',
        key: 'translate',
        type: 'translate',
        category: 'general',
        description: '×ª×¨×’×•× ×ª×•×š ×©××™×¨×” ×¢×œ ×”×¨×•×— ×”××§×•×¨×™×ª',
        content: '×ª×¨×’× ××ª ×”×˜×§×¡×˜ ×”×‘× ×œ×©×¤×” ×”× ×‘×—×¨×ª ×ª×•×š ×©××™×¨×” ×¢×œ ×”× ×§×•×“×•×ª ×•×¢×œ ×”×¨×•×— ×”××§×•×¨×™×ª:',
        tags: ['×ª×¨×’×•×', '×©×¤×•×ª', '×”×¢×‘×¨×”']
    },
    {
        name: '×¢×™×‘×•×“ ××•×ª××',
        key: 'custom',
        type: 'custom',
        category: 'general',
        description: '×¢×™×‘×•×“ ×œ×¤×™ ×”×•×¨××•×ª ××™×•×—×“×•×ª',
        content: '×¢×‘×“ ××ª ×”×˜×§×¡×˜ ×¢×œ ×¤×™ ×”×”×•×¨××•×ª ×”××™×•×—×“×•×ª ×©×¡×•×¤×§×•:',
        tags: ['××•×ª××', '×’××™×©', '×”×•×¨××•×ª']
    },
    {
        name: '×”××©×š ×©×™×—×”',
        key: 'continue',
        type: 'system',
        category: 'system',
        description: '×”××©×š ×©×™×—×” ×•×”×¨×—×‘×” ×¢×œ ×”× ×•×©×',
        content: '×”××©×š ××ª ×”×©×™×—×” ×•×¢× ×” ×¢×œ ×”×©××œ×” ××• ×”×‘×§×©×”:',
        tags: ['×©×™×—×”', '×”××©×š', '×“×™××œ×•×’']
    }
];

async function migratePrompts() {
    try {
        console.log('ğŸ”„ ××ª×—×‘×¨ ×œ××¡×“ ×”× ×ª×•× ×™×...');
        await mongoose.connect(config.MONGODB_URI);
        console.log('âœ… ×”×ª×—×‘×¨×•×ª ×œ××¡×“ ×”× ×ª×•× ×™× ×”×¦×œ×™×—×”');

        // ×™×•×¦×¨ ××©×ª××© ×‘×¨×™×¨×ª ××—×“×œ ×œ××˜×¨×•×ª ×”××™×’×¨×¦×™×”
        const adminUserId = new mongoose.Types.ObjectId();
        
        console.log('ğŸ”„ ××ª×—×™×œ ×”×¢×‘×¨×ª ×¤×¨×•××¤×˜×™×...');
        
        for (const promptData of INITIAL_PROMPTS) {
            try {
                // ×‘×•×“×§ ×× ×”×¤×¨×•××¤×˜ ×›×‘×¨ ×§×™×™×
                const existingPrompt = await Prompt.findOne({ key: promptData.key });
                
                if (existingPrompt) {
                    console.log(`âš ï¸  ×¤×¨×•××¤×˜ '${promptData.key}' ×›×‘×¨ ×§×™×™× - ××“×œ×’`);
                    continue;
                }

                // ×™×•×¦×¨ ×¤×¨×•××¤×˜ ×—×“×©
                const prompt = new Prompt({
                    name: promptData.name,
                    key: promptData.key,
                    type: promptData.type,
                    category: promptData.category,
                    description: promptData.description,
                    tags: promptData.tags,
                    isActive: true,
                    isPublic: true,
                    requiresApproval: false,
                    createdBy: adminUserId,
                    versions: [{
                        version: 1,
                        content: promptData.content,
                        systemPrompt: null,
                        createdBy: adminUserId,
                        changelog: '×’×¨×¡×” ×¨××©×•× ×™×ª - ×”×¢×‘×¨×” ××”×§×•×“',
                        isActive: true
                    }],
                    currentVersion: 1
                });

                await prompt.save();
                console.log(`âœ… ×¤×¨×•××¤×˜ '${promptData.key}' × ×©××¨ ×‘×”×¦×œ×—×”`);

            } catch (error) {
                console.error(`âŒ ×©×’×™××” ×‘×©××™×¨×ª ×¤×¨×•××¤×˜ '${promptData.key}':`, error.message);
            }
        }

        console.log('ğŸ‰ ×”××™×’×¨×¦×™×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!');
        console.log(`ğŸ“Š ×¡×”"×› ×¤×¨×•××¤×˜×™×: ${INITIAL_PROMPTS.length}`);
        
        // ×‘×“×™×§×” ×©×”×¤×¨×•××¤×˜×™× × ×©××¨×•
        const savedPrompts = await Prompt.countDocuments();
        console.log(`ğŸ“ˆ ×¤×¨×•××¤×˜×™× ×‘××¡×“ ×”× ×ª×•× ×™×: ${savedPrompts}`);
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘××™×’×¨×¦×™×”:', error);
    } finally {
        await mongoose.connection.close();
        console.log('ğŸ”’ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™× × ×¡×’×¨');
    }
}

// ×”×¨×¦×”
if (require.main === module) {
    migratePrompts().then(() => {
        console.log('âœ… ×”××™×’×¨×¦×™×” ×”×¡×ª×™×™××”');
        process.exit(0);
    }).catch((error) => {
        console.error('âŒ ×”××™×’×¨×¦×™×” × ×›×©×œ×”:', error);
        process.exit(1);
    });
}

module.exports = { migratePrompts, INITIAL_PROMPTS };